version: '3.8'

services:
  # Application container
  app:
    image: terminal-adventure-game:latest
    container_name: adventure-game-app
    environment:
      - NODE_ENV=production
      - PORT=${PORT:-3001}
      - LMSTUDIO_BASE_URL=${LMSTUDIO_BASE_URL:-http://192.168.0.18:1234}
      - LMSTUDIO_MODEL=${LMSTUDIO_MODEL:-default}
      - LMSTUDIO_TIMEOUT=${LMSTUDIO_TIMEOUT:-30000}
      - LMSTUDIO_TEMPERATURE=${LMSTUDIO_TEMPERATURE:-0.8}
      - LMSTUDIO_MAX_TOKENS=${LMSTUDIO_MAX_TOKENS:-150}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD:-admin123}
    volumes:
      - game-data:/app/backend/data
      - nginx-logs:/var/log/app
    networks:
      - backend
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3001/api/health', (r) => process.exit(r.statusCode === 200 ? 0 : 1))"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

  # Nginx reverse proxy with ModSecurity WAF
  nginx:
    image: adventure-game-nginx:latest
    container_name: adventure-game-nginx
    ports:
      - "${NGINX_PORT:-8888}:80"
    environment:
      - RATE_LIMIT=${RATE_LIMIT:-10r/s}
      - CLIENT_MAX_BODY_SIZE=${CLIENT_MAX_BODY_SIZE:-10M}
    volumes:
      - nginx-logs:/var/log/nginx
    networks:
      - frontend
      - backend
    depends_on:
      app:
        condition: service_healthy
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:80/api/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

  # Fail2ban intrusion prevention
  fail2ban:
    image: adventure-game-fail2ban:latest
    container_name: adventure-game-fail2ban
    environment:
      - FAIL2BAN_BANTIME=${FAIL2BAN_BANTIME:-3600}
      - FAIL2BAN_FINDTIME=${FAIL2BAN_FINDTIME:-600}
      - FAIL2BAN_MAXRETRY=${FAIL2BAN_MAXRETRY:-5}
    volumes:
      - nginx-logs:/var/log/nginx:ro
      - fail2ban-data:/var/lib/fail2ban
    network_mode: host
    cap_add:
      - NET_ADMIN
      - NET_RAW
    depends_on:
      - nginx
    restart: unless-stopped

networks:
  # Frontend network - nginx to internet
  frontend:
    driver: bridge
  
  # Backend network - internal only, nginx to app
  backend:
    driver: bridge
    internal: true

volumes:
  # Persistent game data (database)
  game-data:
    driver: local
  
  # Shared nginx logs for fail2ban
  nginx-logs:
    driver: local
  
  # Fail2ban persistent state
  fail2ban-data:
    driver: local
